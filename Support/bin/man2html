#!/usr/bin/env ruby -wKU

sect, word, scpt = *ARGV

STDOUT << <<-HTML
<html>
<head>
  <meta name="Content-Type" content="text/html; charset=UTF-8" />
  <title>Documentation for “#{word}”</title>
  <script type="text/javascript">
    function man (sect, word) {
      var page = TextMate.system("'#{scpt}' " + sect + " " + word, null).outputString;
      window.location="tm-file://" + page;
    }
  </script>
</head>
<body>
HTML

page = %x{ man #{sect} #{word}|col -b }

toc = [ ]

page.gsub!(/&/, '&amp;')
page.gsub!(/</, '&lt;')
page.gsub!(/``(.*?)''/, '‘‘\1’’')
page.gsub!(/`([^`\n]*?)'/, '‘\1’')
page.gsub!(/\n*^([A-Z0-9_\- ]+)$\n/) { toc << $1; "</pre>\n<h2 id='#$1'>#{$1.capitalize}</h2>\n<pre>" }
page.gsub!(/\b([a-z0-9_.\-]+)\((\d)\)/, '<a href="javascript:man(\2, &quot;\1&quot;)">\1</a>(\2)')

STDOUT << "<select onclick=\"document.location = this.value\">\n"
STDOUT << "<option value=''>— Select a section —</option>\n"
STDOUT << toc.map { |section| "<option value='##{section}'>#{section.capitalize}</option>\n" }.join
STDOUT << "</select>\n"
STDOUT << "<hr>\n"
STDOUT << "<pre>\n"
STDOUT << page
